function __getCookie(key) {
  const cookies = document.cookie.split('; ')
  for (const cookie of cookies) {
    const [cookieKey, cookieValue] = cookie.split('=')
    if (cookieKey === key) {
      return decodeURIComponent(cookieValue)
    }
  }
  return null
}

function __generateID() {
  return `${Math.random()
    .toString(36)
    .slice(2, 2 + 20)}-${Date.now()}`
}

function init() {
  let isLogged = false
  let failedJsCount = 0

  function handleError(e) {
    if (e.target && e.target.src && e.target.src.startsWith(`${window.location.origin}/_next`)) {
      failedJsCount++
    }
  }

  window.addEventListener('error', handleError, true)

  function log() {
    try {
      if (isLogged || !navigator?.sendBeacon) {
        return
      }

      const resources = performance.getEntriesByType('resource')

      const totalJsCount =
        resources.filter(
          (res) =>
            res.initiatorType === 'script' && res.name.startsWith(`${window.location.origin}/_next`)
        ).length || 0

      const failPercentage = Number(((failedJsCount / totalJsCount) * 100).toFixed(1))

      isLogged = true

      const payload = JSON.stringify({
        failPercentage,
        'user.userId': 0,
        project: 'charsou',
        _id: __generateID(),
        totalCount: totalJsCount,
        failedCount: failedJsCount,
        'log.type': 'js-request-failure',
        'page.url': window.location.href,
        'user.userAgent': navigator.userAgent,
        isWebview: !!window?.WebViewInterface,
        'page.route': window.location.pathname,
        'user.deviceId': __getCookie('deviceId'),
      })

      navigator.sendBeacon('https://khabarchin.basalam.com/api_v1.0/logs/statistics', payload)
    } catch (error) {
      console.warn(error)
    }
  }

  if (document.readyState === 'complete') {
    log()
  } else {
    window.addEventListener('load', log, { once: true })
  }
}

init()
